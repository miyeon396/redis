
RDBëŠ” ì§„ì‹¤ì„ ê¸°ë¡í•˜ê³ , RedisëŠ” ì§€ê¸ˆì„ ë³´ì—¬ì¤€ë‹¤.
ë¹ ë¥¸ ì‘ë‹µ, ì¤‘ë³µ ë°©ì§€, ì‹¤ì‹œê°„ ê³µìœ , ë™ì‹œì„± ë°©ì–´ê°€ í•„ìš”í•œ ìˆœê°„ â†’ RedisëŠ” ë¬´ì¡°ê±´ ì´ë“ì…ë‹ˆë‹¤.

Redis cluster ì„¤ì •

- ì„¸ì…˜ê´€ë¦¬ë¥¼ ë ˆë””ìŠ¤ì—ì„œ í• ê±°ë‹¤



* ì˜¤ëŠ˜ í•´ë³´ë©´ ì¢‹ì„ê±°  (ë¬¸ì„œ ë§Œë“¤ì–´ ê³µìœ )

https://chagokx2.tistory.com/99?utm_source=chatgpt.com

1. ì–´ë–¤ê±¸ ê´€ë¦¬í•  ê±´ì§€   
   a. ì„¸ì…˜ ì €ì¥ì†Œ - ê±°ë˜ ì„¸ì…˜ (ë‹¨ê³„ ì§„í–‰ë ë•Œë§ˆë‹¤ ìµœì¢…ë§Œ ê°–ê³  ìˆê³  ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì°¸ì¡° ìš©ë„ì¸ë“¯ ë¹ ë¥¸ ì²˜ë¦¬ë¥¼ ìœ„í•´)
   b. ìºì‹œ - ìì£¼ ì¡°íšŒë˜ëŠ” ì‚¬ìš©ì / ê±°ë˜ ì •ë³´ (ê¸°ì¤€ì •ë³´ë“¤)
   c. ë½ - ì¤‘ë³µ ìš”ì²­ ë°©ì§€ (idempotency, transaction ë‹¨ìœ„ ë½) - í† ìŠ¤ ë¶„ì‚°ë½ í™•ì¸ + ì¤‘ë³µ ìš”ì²­ ë½
   - https://toss.tech/article/cache-traffic-tip?utm_source=chatgpt.com
    - ë” ì„¸ë¶€ì ìœ¼ë¡œ ê°„ë‹¤ë©´ ê°ê°ì€ ì–´ë–¤ ì‹ìœ¼ë¡œ ê´€ë¦¬í•  ì§€
    - ê³„ì¢Œì´ì²´ì— ëŒ€ì…í•´ì„œ ì–´ë–»ê²Œ ì‹œì‘í•´ë³¼ ìˆ˜ ìˆì„ ì§€
2. ì–´ë–»ê²Œ ì„¤ì¹˜í•˜ëŠ”ì§€ ? (ì§ì ‘í•´ë³´ê³ ë°©ë²•ì •ë„ë§Œ)
3. ì–´ë–¤ êµ¬ì¡°ë¥¼ ì‚¬ìš©í•  ê±´ì§€
    - - master-slave/santinel
    - ê° ì •ì˜ì™€ ì¥ë‹¨ì 
4. vm í•œëŒ€ì—ì„œ ì´ë ‡ê²Œ ë§ˆìŠ¤í„° ìŠ¬ë ˆì´ë¸Œë“  ì—¬ëŸ¬ê°œ í•œê±° í…ŒìŠ¤íŠ¸ ì–´ë–»ê²Œ í•´ë³¼ì§€

5. ë©”ëª¨ë¦¬ ìµœì í™”ë‚˜ ìë£Œ êµ¬ì¡° ë“±ì€ ì¸ê°•ìœ¼ë¡œ ë‹¤ì‹œ ê³µë¶€í•˜ê¸°



ê³  ê°€ìš©ì„± -> Sentinel
TPS 600 ì´ìƒ ëŒ€ì‘ + ìŠ¤ì¼€ì¼ ì•„ì›ƒ -> Cluster
ì„¸ì…˜/ë½ë“± ìœ ì‹¤ ë¯¼ê° ë°ì´í„° -> Sentinel êµ¬ì¡° ë‚´ ì‚¬ìš© ê¶Œì¥
ìºì‹œ / ë¹„êµì  ìœ ì‹¤ í—ˆìš© ë°ì´í„° -> Cluster
ë™ê¸° íŠ¸ëœì­ì…˜ (ë½, ì„¸ì…˜) ì¤‘ì‹¬ì¸ê°€? -> Sentinel
VMì€ ëª‡ëŒ€ê¹Œì§€ í™•ë³´ ê°€ëŠ¥í•œê°€? -> ìµœì†Œ 6ëŒ€ -> Cluster êµ¬ì„±


* ì‹¤ë¬´ ì‚¬ë¡€
  | êµ¬ì„±                              | ìš©ë„                             | ì„¤ëª…                              |
  | ------------------------------- | ------------------------------ | ------------------------------- |
  | Redis Sentinel (Master-Replica) | **ì„¸ì…˜**, **ë½**, **idempotency** | íŠ¸ëœì­ì…˜ ìš”êµ¬ / ìœ ì‹¤ ë¯¼ê° / ì›ìì„± ì¤‘ìš”        |
  | Redis Cluster                   | **ì¡°íšŒ ì¤‘ì‹¬ ìºì‹œ**                   | ì‚¬ìš©ì ì •ë³´, ìƒí’ˆ ì •ë³´, ìì£¼ ì¡°íšŒë˜ëŠ” ì •ì  ë°ì´í„° ë“± |
  | Redis Streams (ì„ íƒ)              | **ì‹¤ì‹œê°„ ë©”ì‹œì§€ ì²˜ë¦¬**                 | Kafka ëŒ€ì²´ í˜¹ì€ ë³´ì¡° ìš©ë„               |


Spring Boot
â”œâ”€â”€ RedisCacheUtil â†’ Redis Cluster (ìƒ¤ë”© ìºì‹œ)
â””â”€â”€ RedisLockUtil / SessionManager â†’ Redis Sentinel ê¸°ë°˜ ë‹¨ì¼ Master



ìš©ë„ë³„
ì„¸ì…˜ -> Sentinel -> ìœ ã…œã… ì‹¤ë°©ì§€ í•„ìš”
ê±°ë˜ ì¤‘ë³µ ë°©ì§€ ë½ -> Sentinel -> ì¤‘ë³µ / ì·¨ì†Œ ë°©ì§€ìš© ë¶„ì‚° ë½
ê²°ì œ ID ì‹œí€€ìŠ¤ -> Sentinel -> ìˆœì°¨ IDìƒì„±ì€ Atomic í•´ì•¼í•¨
ì‚¬ìš©ì ì •ë³´ ìºì‹± -> Cluster -> ìºì‹œ miss í—ˆìš©, ì½ê¸° ë¹ˆë„ ë†’ìŒ (ê¸°ì¤€ì •ë³´ ê°™ì€ê±°)
ìƒí’ˆ ì •ë³´ ìºì‹± -> Cluster -> ê³ ë¹ˆë„ ì¡°íšŒ ë°ì´í„° ë¶„ì‚° ì²˜ë¦¬

=> ìµœì¢…
| ìš©ë„            | Redis êµ¬ì¡°     | ì´ìœ                   |
| ------------- | ------------ | ------------------- |
| ì„¸ì…˜ ê´€ë¦¬         | **Sentinel** | ìœ ì‹¤ ì‹œ ì¹˜ëª…ì , atomic í•„ìš” |
| ë½/idempotency | **Sentinel** | ë™ì‹œì„± ì œì–´, ì •í•©ì„±         |
| ì¡°íšŒ ìºì‹œ         | **Cluster**  | TPS ë¶€ë‹´ ë¶„ì‚°, ìœ ì‹¤ í—ˆìš©    |


* ì°¨ì´ ìˆ™ì§€ (êµ¬ì„± ê°œë…)
- Sentinelì€ Redisì˜ Master-Slave ë³µì œ ëª¨ë“œì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥í•œ ê³ ê°€ìš©ì„± êµ¬ì„± ì „ëµ
- Clusterëª¨ë“œëŠ” Sentinelì—†ì´ ìì²´ì ìœ¼ë¡œ ê³  ê°€ìš©ì„±ì„ ì²˜ë¦¬
- Redis êµ¬ì„± ë°©ì‹ ê³¼ Sentinel ê´€ê³„ ì •ë¦¬
    - ë‹¨ì¼ëª¨ë“œì—ì„œëŠ” redis1ëŒ€ë§Œ ìš´ì˜. ê°€ì¥ ë‹¨ìˆœí•˜ì§€ë§Œ ê³  ê°€ìš©ì„± ë¶ˆê°€. sentinel í•„ìš” ì—†ìŒ ì˜ë¯¸ ì—†ìŒ
    - Master-Slave ë³µì œëª¨ë“œ
        - 1ã…¡Master + N Slave
        - íŠ¹ì§• : SlaveëŠ” ë³µì œ ì „ìš© ë§ˆìŠ¤í„° ë‹¤ìš´ ì‹œ ìˆ˜ë™ ì €í™˜ í•„ìš”
        - Sentinel ì‚¬ìš© ì—¬ë¶€: í•„ìˆ˜ì  (ìë™ Failover ë‹´ë‹¹)
        - ì—­í• 
            - Master ê°ì‹œ
            - ì¥ì•  ë°œìƒ ì‹œ ìƒˆë¡œì€ Master ì„ ì¶œ
            - í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ìƒˆë¡œìš´ Master ì •ë³´ ì œê³µ
    - Clusterëª¨ë“œ (Redis Cluster)
        - ìµœì†Œ 3ê°œ Master + 3ê°œ Replica (ë…¸ë“œ í´ëŸ¬ìŠ¤í„°ë§)
            - íŠ¹ì§•
                - ìƒ¤ë”© + ë³µì œ + ìë™ Failover ë‚´ì¥
                - Sentinel ì—†ì´ ìì²´ì ìœ¼ë¡œ HA ì²˜ë¦¬ ê°€ëŠ¥
            - Sentinel ì‚¬ìš© ì—¬ë¶€ : ë¶ˆí•„ìš”. Redis Clusterê³¼ Sentinelì€ ì™„ì „íˆ ë³„ê°œ ì‹œìŠ¤í…œ

- Senteinel, Cluster ë‘˜ë‹¤ ì¥ì•  ë³µêµ¬ë¥¼ ìœ„í•œ ê¸°ìˆ ì´ì§€ë§Œ ì „í˜€ ë‹¤ë¥¸ ë§¥ë½
- Sentinelì€ ì‹±ê¸€ ë§ˆìŠ¤í„° êµ¬ì¡°ì— ì í•©, ClusterëŠ” ë‹¤ì¤‘ ë§ˆìŠ¤í„° + ìƒ¤ë”© í™˜ê²½ì— ì í•©



* ë ˆë””ìŠ¤ êµ¬ì„±ì— ë”°ë¥¸ êµ¬ë¶„
- êµ¬ì„±ì— ë”°ë¼ ë‹¨ì¼ëª¨ë“œ, Master-Slave ë³µì œ ëª¨ë“œ , Cluster ã…ã„´ëª¨ë“œ


redisëŠ” ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ë¡œë„ ìš´ì˜ ê°€ëŠ¥í•˜ì§€ë§Œ ë¬¼ë¦¬ ë¨¸ì‹ ì´ ê°€ì§„ ë©”ëª¨ë¦¬ì˜ í•œê³„ë¥¼ ì´ˆê³¼í•˜ëŠ” ë°ì´í„°ë¥¼ ì €ì¥í•˜ê³  ì‹¶ê±°ë‚˜, failoverì— ëŒ€í•œ ì²˜ë¦¬ë¥´ í†µí•´ HA(ê³ ê°€ìš©ì„±)ì„ ë³´ì¥í•˜ë ¤ë©´
Sentinelì´ë‚˜ Clusterë“±ì˜ ìš´ì˜ ë°©ì‹ì„ ì„ íƒí•´ì„œ ì‚¬ìš©í•´ì•¼ í•œë‹¤

* Sentinel

Master(7000)
- Redis Slave 7001
- Slave 7002
- Slave 7003

- Sentinel 8000
- Sentinel 8001
- Sentinel 8002

ê¸°ëŠ¥ :
- ëª¨ë‹ˆí„°ë§ : Master/Slaveì œëŒ€ë¡œ ë™ì‘í•˜ëŠ”ì§€ ì§€ì†ì  ê°ì‹œ
- ì¥ì•  ì¡°ì¹˜ ìë™
- ì•Œë¦¼ fail overë˜ì—ˆì„ ë•Œ pub/subìœ¼ë¡œ clientì— ì•Œë¦¬ê±°ë‚˜, shell scriptë¡œ ì´ë©”ì¼ì´ë‚˜ smsë¥¼ ë³´ë‚¼ ìˆ˜ ìˆë‹¤.


ë™ì‘ ë°©ì‹
- sentinel ì¸ìŠ¤í„´ìŠ¤ ê³¼ë°˜ ìˆ˜ ì´ìƒì´ Master ì¥ì• ë¥¼ ê°ì§€í•˜ë©´ Slaveí•˜ë‚˜ë¥¼ ë§ˆìŠ¤í„°ë¡œ ìŠ¹ê²©ì‹œí‚¤ê³  ê¸°ì¡´ ë§ˆìŠ¤í„°ëŠ” ìŠ¬ë ˆì´ë¸Œë¡œ ê°•ë“±ì‹œí‚¨ë‹¤
- ìŠ¬ë ˆì´ë¸Œê°€ ì—¬ëŸ¬ê°œ ìˆëŠ” ê²½ìš° ìŠ¬ë˜ì´ë¸Œê°€ ìƒˆë¡œìš´ ë§ˆìŠ¤í„°ë¡œë¶€í„° ë°ì´í„° ë°›ì„ ìˆ˜ ìˆê²Œ ì¬êµ¬ì„±
- ê³¼ë°˜ìˆ˜ ì´ìƒìœ¼ë¡œ ê²°ì •í•˜ëŠ”ë° ì–´ëŠ sentinelì´ ë‹¨ìˆœ ë„¤íŠ¸ì›¤ ì´ìŠˆë¡œ ë§ˆìŠ¤í„°ì™€ ì—°ê²° ì•ˆëœê²½ìš° ê·¸ë•Œ ì‹¤ì œ ë§ˆìŠ¤í„°ëŠ” ë‹¤ìš´ë˜ì§€ ì•Šì•˜ìœ¼ë‚˜ ì—°ê²° ëŠê¸´ sentinelì€ ë§ˆìŠ¤í„°ê°€ ë‹¤ìš´ë˜ì—ˆë‹¤ê³  íŒë‹¨í•  ìˆ˜ ìˆê¸° ë•œëˆ„


---

clusterëƒ sentinelì´ëƒ ë‘˜ë‹¤ ì“¸ ìˆ˜ ìˆëƒ

ìš”êµ¬ ì‚¬í•­
- ìŠ¹ì¸ (ì¤‘ë³µë°©ì§€, ìƒíƒœ ê´€ë¦¬, ì‘ë‹µ íƒ€ì´ë° ì¤‘ìš”, ìœ ì‹¤ ê¸ˆì§€)
- ê±°ë˜ ID ë‹¨ìœ„ë¡œ ìƒíƒœ ê°±ì‹ í•˜ê³  ê´€ë¦¬í•  í•„ìš”ê°€ ìˆìŒ
- ìƒíƒœëŠ” ì •í™•í•´ì•¼í•˜ê³ , í•œë²ˆë§Œ ì²˜ë¦¬ë˜ì–´ì•¼í•¨
- RedisëŠ” ì„¸ì…˜/ë½/ìƒíƒœ ìºì‹œ ìš©ë„ë¡œ ì‚¬ìš” ã…‡

-> Redis Sentinel ê¸°ë°˜ Master-Slave êµ¬ì¡° ì •ë‹µ?

* ì™œ Clusterì•„ë‹ˆê³  Sentinelì´ë‹ˆ
- ë°ì´í„° ìœ ì‹¤ì´ ì ˆëŒ€ ì•ˆë¨ (e.g. ì„¸ì…˜, ê±°ë˜ì •ë³´, í† í°, ìš”ì²­ ì¤‘ê°„ìƒíƒœ ë“±)
- í•­ìƒ ì½ê¸°/ì“°ê¸° consistencyê°€ ë³´ì¥ë˜ì–´ì•¼ í•¨ (ê²°ì œ ì¤‘ì— íŠ¹ì • í‚¤ê°€ ì—†ìœ¼ë©´ í° ì¥ì• )
- ë‹¨ì¼ í‚¤ ê¸°ë°˜ ì ‘ê·¼ì´ ë§ê³  ë©€í‹°í‚¤ ì—°ì‚°ì€ ë“œë¬¾ (ex: ìŠ¹ì¸ì„¸ì…˜, 3DS ìƒíƒœ ë“±)
- ì‹¤ì‹œê°„ì„± ì¤‘ìš” & ë„¤íŠ¸ì›Œí¬ ë¶„í•  ìƒí™©ë„ ê³ ë ¤



| ì¡°ê±´          | ì„¤ëª…                                    | ê²°ê³¼                       |
| ----------- | ------------------------------------- | ------------------------ |
| ìƒíƒœ ì •í™•ì„±      | ê±°ë˜ ìŠ¹ì¸/ì·¨ì†ŒëŠ” ì¤‘ë³µë˜ë©´ ì•ˆ ë¨                    | ì›ìì„± í•„ìˆ˜ â†’ âŒ Cluster ë¶€ì í•©   |
| ë½ í•„ìš”        | Redis Lock (SETNX ë“±) â†’ ë¶„ì‚°ë½ í•„ìš”         | ClusterëŠ” ìŠ¬ë¡¯ ë‹¤ë¥´ë©´ ì›ì ì—°ì‚° ë¶ˆê°€ |
| í‚¤ í•˜ë‚˜ì— ì—¬ëŸ¬ ì—°ì‚° | `GET`, `SET`, `INCR`, `DEL` ë“± ë³µí•© ì›ìì—°ì‚° | ClusterëŠ” ì œí•œ ë§ìŒ           |
| ì—…ë¬´ ë³µì¡ë„      | ìŠ¹ì¸ = ë§¤ìš° ë¯¼ê°í•œ ë„ë©”ì¸                       | ë°ì´í„° ì¼ê´€ì„± ìµœìš°ì„               |

Clusterê°€ ì•ˆë§ëŠ” ì´ìœ 
| í•­ëª©                | ì„¤ëª…                                                                                             |
| ----------------- | ---------------------------------------------------------------------------------------------- |
| **ë°ì´í„° ìƒ¤ë”© êµ¬ì¡°**     | Redis ClusterëŠ” ë°ì´í„°ë¥¼ slotìœ¼ë¡œ ë¶„ì‚°í•´ì„œ ì €ì¥í•¨. <br> â†’ ë‹¨ì¼ í‚¤ëŠ” ê´œì°®ì§€ë§Œ, **ë©€í‹° í‚¤ ì—°ì‚°ì´ ì–´ë µê³ ** íŒŒì´í”„ë¼ì¸ ì²˜ë¦¬ë„ ì œí•œë¨.        |
| **ë„¤íŠ¸ì›Œí¬ íŒŒí‹°ì…˜ ë°œìƒ ì‹œ** | íŠ¹ì • ìŠ¬ë¡¯ì´ ì¼ë¶€ ë…¸ë“œì—ë§Œ ìˆê³  ì—°ê²°ì´ ëŠê¸°ë©´ **í‚¤ ì ‘ê·¼ ìì²´ê°€ ë¶ˆê°€ëŠ¥**í•´ì§.<br> â†’ ê²°ì œ ì²˜ë¦¬ ì¤‘ ì´ëŸ° ìƒí™©ì€ ì‹¬ê°í•œ ì¥ì• ë¥¼ ì¼ìœ¼í‚´.                |
| **Failover ë³µì¡ì„±**  | ìë™ failoverëŠ” ë˜ì§€ë§Œ, **íŠ¸ëœì­ì…˜ ë„ì¤‘ì— failoverê°€ ì¼ì–´ë‚˜ë©´** ì¥ì•  ê°€ëŠ¥ì„± ìˆìŒ.<br> ì˜ˆ: ìŠ¹ì¸ì´ ì„±ê³µí–ˆëŠ”ë°, í‚¤ ì¡°íšŒ ì‹¤íŒ¨ë¡œ ë¬´íš¨ì²˜ë¦¬ ë˜ëŠ” ê²½ìš° |
| **ì“°ê¸° ì¼ê´€ì„± ë³´ì¥ ì–´ë ¤ì›€** | í´ëŸ¬ìŠ¤í„° ëª¨ë“œì—ì„œëŠ” **ê°•ë ¥í•œ ì“°ê¸° ì¼ê´€ì„±(write consistency)** ë³´ì¥ì´ ì–´ë ¤ì›€<br> (ë™ì‹œì“°ê¸°, ë³µì œ ì§€ì—° ë“± ê³ ë ¤í•´ì•¼ í•¨)                |

â†’ ê²°ì œ ìŠ¹ì¸ ê°™ì€ ë¯¼ê°í•œ ì‘ì—…ì€ Redis Cluster ì ˆëŒ€ ë¹„ì¶”

RedisSentinelí•´ì•¼í•˜ëŠ” ì´ìœ 
| í•­ëª©                    | ì„¤ëª…                                                                                             |
| --------------------- | ---------------------------------------------------------------------------------------------- |
| **ë‹¨ì¼ ë§ˆìŠ¤í„° êµ¬ì¡°**         | Sentinelì€ Master-Slave êµ¬ì¡°ë¥¼ ì‚¬ìš©í•¨. <br> ëª¨ë“  ì“°ê¸°ëŠ” Masterë¡œ ì§‘ì¤‘ë˜ë¯€ë¡œ **ì¼ê´€ì„±(Consistency)** í™•ë³´ê°€ ì‰¬ì›€.         |
| **ê°„ë‹¨í•œ ë©€í‹°í‚¤ ì—°ì‚° ê°€ëŠ¥**     | í´ëŸ¬ìŠ¤í„°ì²˜ëŸ¼ ìƒ¤ë”©ì´ ì—†ìœ¼ë¯€ë¡œ ë©€í‹° í‚¤ ì—°ì‚°, íŠ¸ëœì­ì…˜, Lua ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš©ì´ ììœ ë¡œì›€                                               |
| **ë¹ ë¥´ê³  ì•ˆì •ì ì¸ Failover** | Sentinelì´ ë§ˆìŠ¤í„°ë¥¼ ê°ì‹œí•˜ê³  ë¬¸ì œê°€ ìƒê¸°ë©´ ìë™ìœ¼ë¡œ Slaveë¥¼ Masterë¡œ ì „í™˜<br> â†’ ì•±ë‹¨ì—ì„œ ìë™ ê°ì§€ ê°€ëŠ¥ (Lettuce, Jedis ëª¨ë‘ ì§€ì›)  |
| **ì‹¤ì‹œê°„ì„±/ì •í•©ì„±**          | ë³µì œ ì§€ì—°ì´ ìˆê¸´ í•˜ì§€ë§Œ, Read Replicaë¡œ ë¶„ë¦¬í•´ë„ **ì‹¤ì‹œê°„ì„±ì´ í¬ê²Œ í›¼ì†ë˜ì§€ ì•ŠìŒ** <br> â†’ ì¤‘ìš”í•œ ìŠ¹ì¸ ë°ì´í„°ëŠ” í•­ìƒ Masterì—ì„œ ì½ê²Œ ì„¤ì • ê°€ëŠ¥ |


=>
| í•­ëª©              | Sentinel | Cluster                     |
| --------------- | -------- | --------------------------- |
| ê³ ê°€ìš©ì„± (Failover) | âœ… ì•ˆì •ì     | âœ… ê°€ëŠ¥í•˜ë‚˜ íŠ¸ëœì­ì…˜ ì¤‘ ìœ„í—˜            |
| ë°ì´í„° ì •í•©ì„±         | âœ… ê°•í•¨     | âš ï¸ ìƒ¤ë”©/íŒŒí‹°ì…˜ì— ë”°ë¼ ë¶ˆì•ˆì •           |
| ì“°ê¸° ì¼ê´€ì„±          | âœ… ë³´ì¥     | âŒ ì•½í•¨ (replica lag ë“± ì¡´ì¬)     |
| ë³µì¡ë„             | âœ… ë‹¨ìˆœ     | âŒ ë³µì¡ (slot ê´€ë¦¬, hash tag í•„ìš”) |
| ìŠ¹ì¸/ê²°ì œ ì í•©ì„±       | ğŸŸ¢ ë§¤ìš° ì í•© | ğŸ”´ ë¹„ì í•©                      |

-> ìŠ¹ì¸/ê²°ì œ ì‹œìŠ¤í…œì€ ì•ˆì •ì„±ê³¼ ì¼ê´€ì„±ì´ ì ˆëŒ€ì  ê°€ì¹˜ì´ê¸° ë•Œë¬¸ì—, ê³ ì„±ëŠ¥ë³´ë‹¤ëŠ” ì •í•©ì„± ë³´ì¥, ê°„ë‹¨í•œ êµ¬ì¡°, ì¥ì•  ëŒ€ë¹„ê°€ ì‰¬ìš´ Sentinel êµ¬ì¡°ê°€ í›¨ì”¬ ë” ì í•©í•©ë‹ˆë‹¤.



* ì–´ì¼€ ë‚˜ëˆ„ëŠ”ê²Œ ì¢‹ì€ ì§€
- ìŠ¹ì¸ìƒíƒœ/ê±°ë˜ì²˜ë¦¬ìƒíƒœ/ë½ -> Sentinel ê¸°ë°˜ Redis
- ìƒí’ˆ ì •ë³´, í™˜ìœ¨, ì¹´ë“œì‚¬ ëª©ë¡, ì‚¬ìš©ì ì´ë¦„ ìºì‹œ -> Cluster ê¸°ë°˜ Redis
  -> ìŠ¹ì¸ íë¦„ì€ Sentinel, ë‹¤ë¥¸ ë¶€ê°€ ìºì‹œëŠ” Cluster (í•„ìš”í•œê²½ìš°)
  spring.redis.sentinel â†’ ìŠ¹ì¸ìš© Redis
  spring.redis.cluster â†’ ìºì‹œ ì „ìš© Redis (ì„ íƒ)
  -> RedisTemplateì„ 2ê°œ êµ¬ì„±í•´ì„œ @Qualifierë¡œ êµ¬ë¶„

=> ê²°ë¡ 
| ì„ íƒ ëŒ€ìƒ              | ì„ íƒ êµ¬ì„±                                      | ì´ìœ                                 |
| ------------------ | ------------------------------------------ | --------------------------------- |
| **ê²°ì œ ìŠ¹ì¸ íë¦„**       | **Redis Sentinel ê¸°ë°˜ ë‹¨ì¼ Master-Replica êµ¬ì¡°** | ì •í™•ì„±, ì›ìì„±, ë½, ì¥ì•  ëŒ€ì‘                |
| **ê³ ë¹ˆë„ ì¡°íšŒ ìºì‹œ (ì„ íƒ)** | **Redis Cluster (ì„ íƒì )**                    | íŠ¸ë˜í”½ ë¶„ì‚°, ì„±ëŠ¥ í–¥ìƒ (ë‹¨, ìœ ì‹¤ í—ˆìš©ë˜ëŠ” ìºì‹œì— í•œí•¨) |

"ì„¸ì…˜ì€ ì‹¤ì‹œê°„ì´ê³  ìœ ì‹¤ë˜ë©´ ì•ˆ ë˜ëŠ” ë°ì´í„° â†’ Sentinelì´ ë§ë‹¤."
"ìˆ˜ì²œ ëª… ë™ì‹œ ìš”ì²­ë„ Sentinel + íŠœë‹ìœ¼ë¡œ ì¶©ë¶„íˆ ê°ë‹¹ ê°€ëŠ¥í•˜ë‹¤."
"ClusterëŠ” ìŠ¹ì¸ ì—…ë¬´ì—ì„œëŠ” ì ˆëŒ€ ë¹„ì¶”ë‹¤."



â€œê²°ì œ ìŠ¹ì¸ì€ Redis Sentinel êµ¬ì¡°ë¡œë§Œ ì²˜ë¦¬í•˜ê³ , ì¡°íšŒ ìºì‹œê°€ ì •ë§ ê³ TPSë¼ë©´ Redis Clusterë¥¼ ë¶€ê°€ì ìœ¼ë¡œ ì‚¬ìš©í•˜ë¼.â€



ëŒ€ìš©ëŸ‰ì´ë©´ ë¹ ë¥¸ ì „ë‹¬ì´ë©´ Clusterì¸ë°

cluster
ê·¸ë¦¬ê³  ë’¤ì—ì„œ ë” ìì„¸íˆ ì„¤ëª…í•˜ê² ì§€ë§Œ ì‚¬ì‹¤ 6ëŒ€ë„ ì•„ë‹ˆê³  7ëŒ€ì…ë‹ˆë‹¤. Redis Clusterë¥¼ êµ¬ì¶•í•  ë•Œ ê³ ë ¤í•´ì•¼í•  ì‚¬í•­ ì¤‘ í•˜ë‚˜ì¸ Split Brain í˜„ìƒ ë•Œë¬¸ì— ë…¸ë“œë¥¼ í™€ìˆ˜ê°œë¡œ ìœ ì§€í•´ì•¼í•˜ê±°ë“ ìš”. ê·¸ëŸ¼ 7ëŒ€ê°€ Redis Clusterë¥¼ ìš´ì˜í•˜ê¸°ìœ„í•œ ìµœì†Œ ì„œë²„ ëŒ€ìˆ˜ì…ë‹ˆë‹¤.
- Redis Sentinel/ClusterëŠ” ì¥ì•  ë°œìƒ ì‹œ ìë™ failoverë¥¼ ìœ„í•´ "íˆ¬í‘œ(quorum)"ë¥¼ ì‚¬ìš©í•¨
- ì´ë•Œ, í´ëŸ¬ìŠ¤í„°ì— ì†í•œ ì ˆë°˜ ì´ìƒì´ ì‚´ì•„ìˆìŒì„ íŒë‹¨í•  ìˆ˜ ìˆì–´ì•¼ ìë™ ì „í™˜ì´ ê°€ëŠ¥í•¨
- ë…¸ë“œ ìˆ˜ê°€ ì§ìˆ˜ë©´ ì •í™•íˆ ë°˜ìœ¼ë¡œ ìª¼ê°œì¡Œì„ ë•Œ ì–´ëŠ ìª½ì´ ì£¼ì¸ì§€ íŒë‹¨í•  ìˆ˜ ì—†ìŒ â†’ Split brain ë°œìƒ ìœ„í—˜ ì¦ê°€

-> ìµœì†Œ
clusetr
| í•­ëª©         | ìˆ˜ëŸ‰                                      |
| ---------- | --------------------------------------- |
| Redis ë…¸ë“œ ìˆ˜ | 6ê°œ (3 master + 3 replica)               |
| ìµœì†Œ VM ìˆ˜    | âœ… **3ëŒ€**                                |
| ë°°ì¹˜ ë°©ì‹      | ê° VMë‹¹ master 1ê°œ + ë‹¤ë¥¸ masterì˜ replica 1ê°œ |
| ì˜ˆì‹œ êµ¬ì„±      |                                         |


sentinel
| í•­ëª©         | ìˆ˜ëŸ‰                                                  |
| ---------- | --------------------------------------------------- |
| Redis ì„œë²„ ìˆ˜ | âœ… **2ëŒ€** (1 master + 1 replica)                     |
| Sentinel ìˆ˜ | âœ… **3ëŒ€ ì´ìƒ (í™€ìˆ˜)**                                    |
| ìµœì†Œ VM ìˆ˜    | âœ… **3ëŒ€** ì´ìƒ<br>(master, replica, sentinel ê°ê° ë¶„ë¦¬ ê°€ëŠ¥) |

ã…‹ã…‹ã…‹ê²°êµ­ ë‘˜ë‹¤ 3ëŒ€ëŠ” í•„ìš”í•¨

ê³µì‹ë¬¸ì„œì—ì„œë„ Sentinelì€ ì†Œ, ì¤‘ê·œëª¨ì˜ ì„œë¹„ìŠ¤ì—ì„œ ClusterëŠ” ëŒ€ê·œëª¨ ì„œë¹„ìŠ¤ì—ì„œ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ì¶”ì²œí•œë‹¤ê³  ë‚˜ì™€ìˆìŠµë‹ˆë‹¤.

https://coding-review.tistory.com/542
ì™œ sentinel
ìƒ¤ë”©ë„ ìƒ¤ë”©ì´ê³  ë¹ ë¥¸ ì‘ë‹µ ë„ ë¹ ë¥¸ ì‘ë‹µì´ì§€ë§Œ ì¢€ ë” ë†’ì€ ê°€ìš©ì„±ì„ ì„ íƒí•˜ëŠ”ê²Œ ì¡°ê¸ˆ ë” í•©ë¦¬ì ì¸ ì„ íƒ
redisì— ì˜ì¡´í•˜ëŠ” ë¶€ë¶„ì´ ë§ìœ¼ë©´ redisê°€ ì£½ìœ¼ë©´ ë’¤ì—ìˆëŠ” RDBMSê¹Œì§€ ì£½ì–´ ì„œë¹„ìŠ¤ ì „ì²´ ì¥ì•  ê°€ëŠ¥ì„±
Redis Sentinelì€ ìì²´ì ì¸ Notificationì„ ê°€ì§€rhdlTek.

https://imehboob.medium.com/your-easy-guide-to-design-highly-available-system-with-redis-part-1-812d3baec45b
https://redis.io/docs/latest/operate/oss_and_stack/management/scaling/?utm_source=chatgpt.com
->
1. Redis í´ëŸ¬ìŠ¤í„° ì¼ê´€ì„± ë³´ì¥
   Redis í´ëŸ¬ìŠ¤í„°ëŠ” ê°•ë ¥í•œ ì¼ê´€ì„±ì„ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ . ì‹¤ì œë¡œ ì´ëŠ” íŠ¹ì • ì¡°ê±´ì—ì„œ Redis í´ëŸ¬ìŠ¤í„°ê°€ ì‹œìŠ¤í…œì´ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ í™•ì¸(acknowledged)í•œ ì“°ê¸° ë‚´ìš©ì„ ìƒì„ ìˆ˜ ìˆìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.

2. ì„¸ ë²ˆì§¸ ì‚¬ë¡€ëŠ” Redis í´ëŸ¬ìŠ¤í„°ì—ì„œ ì²˜ë¦¬ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì¦‰, ì—¬ëŸ¬ í‚¤ ì‘ì—…ì„ ì‚¬ìš©í•˜ì§€ ì•Šê±°ë‚˜ ë™ì¼í•œ í•´ì‹œ íƒœê·¸ì˜ ì»¨í…ìŠ¤íŠ¸ì—ì„œë§Œ ì‚¬ìš©í•˜ë„ë¡ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.


https://notavoid.tistory.com/231


---



0. ìš°ë¦¬ê°€ í•„ìš”í•œê±°
- ì„¸ì…˜ê´€ë¦¬
- ë½ê´€ë¦¬
- ìºì‹±(ê¸°ì¤€ì •ë³´)
  ì•ì—ì„œ ê°€ì ¸ì˜¤ê¸° TODO ::

1. ì„ íƒ í•œê±°
    - standaloneëŠ” ê± ê³µë¶€ìš©
    - Maseter-slave with Sentienl
    - Cluster

2. ê³ ë¯¼
    - ë³µì¡í•˜ê²Œ ê°€ëŠëƒ ì‰½ê²Œ ê°€ëŠëƒ
    - HA ì–´ëŠì •ë„ ë³´ì¥ë˜ë©° ì•ˆì •ì„± ìˆëŠ” Sentinel
    - í™•ì¥ ìš©ì´í•˜ê³  ê³ ë¯¼ ë§ì´ í•´ì•¼í•˜ëŠ” Cluster
    - ê°œì¸ì ìœ¼ë¡  Sentinelì¸ë° ì¤‘ì†Œê·œëª¨ë¼ê³  ë§ì´ ë§í•˜ëŠ”ê²Œ ì´ˆì¡°í•¨. ë­ê°€ ì¢‹ì€ì§€ ê³ ë¯¼ì´ í•„ìš”í•˜ë‹¤
    - TODO :: ì•ì—ì„œ ê°€ì ¸ì˜¤ê¸°
    -  ë¶„ì‚° ì‹œìŠ¤í…œì—ì„œ ì„±ëŠ¥ì€ ë°ì´í„° ì¼ê´€ì„±ê³¼ trade-offê°€ ìˆë‹¤. Redis ClusterëŠ” ê³ ì„±ëŠ¥ì˜ í™•ì¥ì„±ì„ ì œê³µí•˜ë©´ì„œë„ ì¼ì • ìˆ˜ì¤€ì˜ ì•ˆì •ì„±ê³¼ ê°€ìš©ì„±ì„ ìœ ì§€í•˜ëŠ” ê²ƒì„ ëª©í‘œë¡œ ì„¤ê³„
    - https://rhgustmfrh.tistory.com/123 ê·¸ë¦¼ì“°ê¸°

3. Sentinel êµ¬ì„± ë° ë¡œì»¬ í…ŒìŠ¤íŠ¸ ë°©ë²•
   a. êµ¬ì„±
   - ë¡œì»¬ì— êµ¬ì„±
   1. ë ˆë””ìŠ¤ ê¹œ (ìœˆë„ìš°ëŠ” ë‹¤ì‹œ í™•ì¸, ë§¥ì—ì„  ë„ì»¤ë¡œ í•˜ë‹¤ê°€ ê·¸ëƒ¥ ê¹”ì•„ë¶€ë¦¼) 
      - $brew install wget
        $ mkdir redis
        $ cd redis
        $ wget http://download.redis.io/releases/redis-7.4.2.tar.gz
        $ tar xzf redis-7.4.2.tar.gz
        $ cd redis-7.4.2
        $ make // ì†ŒìŠ¤ ì»´íŒŒì¼(=ì†ŒìŠ¤ íŒŒì¼ì„ ì‹¤í–‰ ê°€ëŠ¥í•œ í˜•íƒœë¡œ ë§Œë“¤ì–´ ì¤€ë‹¤)
        $ sudo make install // /usr/local/binì— redis-server, redis-cli ë“± ì‹¤í–‰ íŒŒì¼ì´ ë³µì‚¬
        $ redis-server redis.conf
   2. master (redis.config ê·¸ëŒ€ë¡œ ì‚¬ìš©) (2~5configëŠ” ë¶™ì´ê² ìŒ)
   3. redis-replica.config
   4. sentinel.conf (ê·¸ëŒ€ë¡œì‚¬ìš© failoverë§Œ ì¶”ê°€)
   5. redis-sentinel2.conf, redis-sentinel3.conf ì¶”ê°€ (failover timeoutë§Œ ì§§ê²Œ (í…ŒìŠ¤íŠ¸), port ë³€ê²½, ì´í›„ latencyì§§ê²Œ)
   6. redis-server redis.conf / redis-sentinel sentinels ë‹¤ë„ì›€
   7. ì£½ì´ê³  ì‚´ë¦¬ë©° í™•ì¸
      - redis-cli -p 26379 SENTINEL masters , redis-cli -p 26379 SENTINEL get-master-addr-by-name mymaster, redis-cli -p 6380 shutdown

   - ì½”ë“œ 
       - Lettuce Client
           - ì„¼í‹°ë„¬ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì—°ê²°í•˜ë ¤ë©´ ì„¼í‹°ë„¬ ìì²´ë„ ì§€ì›í•˜ëŠ” í´ë¼ì´ì–¸íŠ¸ë¥¼ ì‚¬ìš©í•´ì•¼í•¨
           - SpringDataRedisì‚¬ìš© êµ¬ì„± í¬ê²Œ ì¤„ì„
           - LettuceëŠ” Redisì— ê¶Œì¥ë˜ëŠ” Java Client ì¤‘ í•˜ë‚˜ 
           - ìŠ¤ë ˆë“œë¡œë¶€í„° ì•ˆì „í•œ ë™ê¸°í™”, ë¹„ë™ê¸° ë° ë°˜ì‘ì  ì‚¬ìš©ì„ ìœ„í•œ ê³ ê¸‰ Redis í´ë¼ì´ì–¸íŠ¸, í´ëŸ¬ìŠ¤í„°, ì„¼í‹°ë„¬, íŒŒì´í”„ë¼ì´ë‹ ë° ì½”ë± ì§€ì›
           - ë” ë¬´ê±°ìš´ APIë¥¼ ë§Œë“œëŠ” í†µì‹ ì—ëŠ” Nettyë¥¼ ì‚¬ìš©í•˜ì§€ë§Œ ë‘˜ ì´ìƒì˜ ìŠ¤ë ˆë“œì™€ ì—°ê²° ê³µìœ í•˜ëŠ”ë° ë” ì¢‹ìŒ
           - SpringDataRedisëŠ” ê¸°ë³¸ì ìœ¼ë¡œ Lettuce ì‚¬ìš©
           - Springì—ì„œ Lettuce í´ë¼ì´ì–¸íŠ¸ì™€ í•¨ê»˜ Redis êµ¬ì„±í•˜ê³  ì‚¬ìš©í•˜ì—¬ ì§ì ‘ ì‚¬ìš©í•  ìˆ˜ ìˆë˜ë¡ í•˜ëŠ” ë°©ë²• 

       - 


    b. í…ŒìŠ¤íŠ¸ ë°©ë²• 
        - failover
            - master(6379), replica(6380), sentinel1(26379), sentinel2(26380), sentinel3(26381)
            - master ì£½ì„ : no Ctrl+C yes redis-cli -p 6379 SHUTDOWN NOSAVE

    c. session ê´€ë¦¬ìš© ì½”ë“œ êµ¬ì„± 


4. Cluster êµ¬ì„± ë° ë¡œì»¬ í…ŒìŠ¤íŠ¸ ë°©ë²•
   a. êµ¬ì„±

   b. í…ŒìŠ¤íŠ¸ ë°©ë²•

   c. session ê´€ë¦¬ìš© ì½”ë“œ êµ¬ì„±



5. ê° ì˜µì…˜ì´ë‚˜ ì„¤ì •ë“¤ ê³µë¶€í•˜ê¸°
- TODO ::
- https://www.letmecompile.com/redis-cluster-sentinel-overview/
- ì˜µì…˜ë“¤
- ì„¤ì •ë“¤




4. ë‚œ ì´ë˜ì´ë˜í•´ì„œ Sentinelì´ ë§ëŠ”ê²ƒ ê°™ë‹¤ 

---
1)redis.conf ê·¸ëŒ€ë¡œ

2)redis-replica.conf

port 6380


3)sentinels.conf (ê¸°ë³¸ì¸ë° ì´ê²ƒë“¤ë§Œ ë³€ê²½)
sentinel down-after-milliseconds mymaster 5000
sentinel failover-timeout mymaster 10000
(
# sentinel failover-timeout <master-name> <milliseconds>
#
# Specifies the failover timeout in milliseconds. It is used in many ways:
#
# - The time needed to re-start a failover after a previous failover was
#   already tried against the same master by a given Sentinel, is two
#   times the failover timeout.
#
# - The time needed for a replica replicating to a wrong master according
#   to a Sentinel current configuration, to be forced to replicate
#   with the right master, is exactly the failover timeout (counting since
#   the moment a Sentinel detected the misconfiguration).
#
# - The time needed to cancel a failover that is already in progress but
#   did not produced any configuration change (SLAVEOF NO ONE yet not
#   acknowledged by the promoted replica).
#
# - The maximum time a failover in progress waits for all the replicas to be
#   reconfigured as replicas of the new master. However even after this time
#   the replicas will be reconfigured by the Sentinels anyway, but not with
#   the exact parallel-syncs progression as specified.
#
# Default is 3 minutes.

)

4) redis-sentinel2.conf
   sentinel down-after-milliseconds mymaster 5000
   sentinel monitor mymaster 127.0.0.1 6380 2
   sentinel failover-timeout mymaster 10000
   port 26380
